{# @author : Dufour Marc (marc.dufour@stjosup.com)
 # @version : 2.0
 # @dateCreate : 02/02/2026
 # @lastUpdate : 02/02/2026 (Largeur adaptative + modale description)
 #}

{# Structure de la Modale Principale #}
<dialog id="livre-modal" class="modal-livre-details">
    <div id="modal-content"></div>
    <button type="button" class="btn btn-secondary" onclick="document.getElementById('livre-modal').close()">
        Fermer
    </button>
</dialog>

{# Modale secondaire pour la description complète #}
<dialog id="description-modal" class="modal-description">
    <div class="modal-description-header">
        <h3><i class="fas fa-book-open"></i> Description complète</h3>
    </div>
    <div id="description-content" class="modal-description-content"></div>
    <div class="modal-description-footer">
        <button type="button" class="btn btn-secondary" onclick="closeDescriptionModal()">
            Fermer
        </button>
    </div>
</dialog>

<script>
/**
 * Fonction utilitaire pour charger du contenu dans la modale principale
 */
async function loadToModal(url) {
    const modal = document.getElementById('livre-modal');
    const content = document.getElementById('modal-content');

    try {
        const response = await fetch(url, {
           headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const html = await response.text();
        content.innerHTML = html;
        
        // Initialiser les boutons "Voir plus" après chargement du contenu
        initVoirPlusButtons();
        
        if (modal && !modal.open) {
            modal.showModal();
        }
    } catch (err) {
        console.error('Erreur de chargement :', err);
    }
}

/**
 * Ouvre la modale de description
 */
function openDescriptionModal(description) {
    const modal = document.getElementById('description-modal');
    const content = document.getElementById('description-content');
    
    content.textContent = description || 'Aucune description disponible.';
    modal.showModal();
}

/**
 * Ferme la modale de description
 */
function closeDescriptionModal() {
    const modal = document.getElementById('description-modal');
    modal.close();
}

/**
 * Initialise les boutons "Voir plus" pour les descriptions
 */
function initVoirPlusButtons() {
    document.querySelectorAll('.btn-voir-plus').forEach(button => {
        button.addEventListener('click', function() {
            const description = this.dataset.fullDescription;
            openDescriptionModal(description);
        });
    });
}

/**
 * Ferme la modale description si on clique en dehors
 */
document.addEventListener('DOMContentLoaded', function() {
    const descModal = document.getElementById('description-modal');
    
    if (descModal) {
        descModal.addEventListener('click', function(e) {
            // Si on clique directement sur la dialog (backdrop), on ferme
            if (e.target === descModal) {
                closeDescriptionModal();
            }
        });
    }
});

// --- GESTION MODALE PRINCIPALE ---

// 1. OUVERTURE : Clic sur le nom (Show) ou sur Modifier (Edit)
document.addEventListener('click', (e) => {
    const trigger = e.target.closest('.modal-trigger, .edit-modal-trigger');
    if (trigger) {
        e.preventDefault();
        loadToModal(trigger.href);
    }
});

// 2. ENREGISTREMENT : Intercepter la soumission du formulaire
document.addEventListener('submit', async (e) => {
    const content = document.getElementById('modal-content');
    // On vérifie que le formulaire soumis est bien DANS la modale
    if (!content || !content.contains(e.target)) return;

    const modal = document.getElementById('livre-modal');
    const form = e.target;
    
    e.preventDefault();
    const formData = new FormData(form);

    // Ajout manuel du bouton de soumission au FormData
    if (e.submitter && e.submitter.name) {
        formData.append(e.submitter.name, e.submitter.value);
    }

    const actionUrl = form.getAttribute('action') || window.location.href;

    try {
        const response = await fetch(actionUrl, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        if (response.ok) {
            try {
                const result = await response.json();
                if (result.success) {
                    modal.close();
                    window.location.reload(); 
                    return;
                }
            } catch (jsonErr) {
                modal.close();
                window.location.reload();
            }
        } else if (response.status === 422) {
            // Erreur de validation : on remplace le formulaire par celui avec les erreurs
            content.innerHTML = await response.text();
            // Réinitialiser les boutons "Voir plus"
            initVoirPlusButtons();
        }
    } catch (err) {
        console.error("Erreur lors de l'envoi :", err);
    }
});
</script>
