{# @author : Dufour Marc (marc.dufour@stjosup.com)
 # @version : 2.2
 # @dateCreate : 02/02/2026
 # @lastUpdate : 02/02/2026 (Unification avec modal_handler.js)
 #}

{# Structure de la Modale Principale - UNIFIÉ avec modal_handler.js #}
<dialog id="modale_principale" class="modal-livre-details">
    <div id="contenu_modale"></div>
</dialog>

{# Modale secondaire pour la description complète #}
<dialog id="description-modal" class="modal-description">
    <div class="modal-description-header">
        <h3><i class="fas fa-book-open"></i> Description complète</h3>
        <button type="button" class="btn-close-description" onclick="closeDescriptionModal()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div id="description-content" class="modal-description-content"></div>
    <div class="modal-description-footer">
        <button type="button" class="btn btn-secondary" onclick="closeDescriptionModal()">
            Fermer
        </button>
    </div>
</dialog>

<script>
/**
 * Ouvre la modale de description
 */
function openDescriptionModal(description) {
    const modal = document.getElementById('description-modal');
    const content = document.getElementById('description-content');
    
    content.textContent = description || 'Aucune description disponible.';
    modal.showModal();
}

/**
 * Ferme la modale de description
 */
function closeDescriptionModal() {
    const modal = document.getElementById('description-modal');
    modal.close();
}

/**
 * Initialise les boutons "Voir plus" pour les descriptions
 */
function initVoirPlusButtons() {
    document.querySelectorAll('.btn-voir-plus').forEach(button => {
        button.addEventListener('click', function() {
            const description = this.dataset.fullDescription;
            openDescriptionModal(description);
        });
    });
    console.log('initVoirPlusButtons: ' + document.querySelectorAll('.btn-voir-plus').length + ' bouton(s) initialisé(s)');
}

/**
 * Observer pour détecter quand du nouveau contenu est chargé dans la modale
 */
document.addEventListener('DOMContentLoaded', function() {
    const contenuModale = document.getElementById('contenu_modale');
    
    if (contenuModale) {
        console.log('MutationObserver: Attaché à #contenu_modale');
        
        // Observer les changements dans le contenu de la modale
        const observer = new MutationObserver(function(mutations) {
            // Vérifier si des boutons "Voir plus" ont été ajoutés
            const voirPlusButtons = document.querySelectorAll('.btn-voir-plus');
            if (voirPlusButtons.length > 0) {
                console.log('MutationObserver: Détection de ' + voirPlusButtons.length + ' bouton(s) "Voir plus"');
                // Attendre un peu que le DOM soit stable
                setTimeout(function() {
                    initVoirPlusButtons();
                }, 100);
            }
        });
        
        // Observer les changements d'enfants dans le contenu de la modale
        observer.observe(contenuModale, { 
            childList: true, 
            subtree: true 
        });
    } else {
        console.error('ERREUR: #contenu_modale n\'existe pas !');
    }
    
    // Fermeture de la modale description sur clic extérieur
    const descModal = document.getElementById('description-modal');
    if (descModal) {
        descModal.addEventListener('click', function(e) {
            if (e.target === descModal) {
                closeDescriptionModal();
            }
        });
        console.log('Event listener: Fermeture sur clic extérieur attaché à #description-modal');
    }
});

/**
 * Intercepter la soumission des formulaires dans la modale
 */
document.addEventListener('submit', async (e) => {
    const content = document.getElementById('contenu_modale');
    if (!content || !content.contains(e.target)) return;

    const modal = document.getElementById('modale_principale');
    const form = e.target;
    
    e.preventDefault();
    const formData = new FormData(form);

    if (e.submitter && e.submitter.name) {
        formData.append(e.submitter.name, e.submitter.value);
    }

    const actionUrl = form.getAttribute('action') || window.location.href;

    try {
        const response = await fetch(actionUrl, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        if (response.ok) {
            try {
                const result = await response.json();
                if (result.success) {
                    if (typeof fermerModale === 'function') {
                        fermerModale();
                    } else {
                        modal.close();
                        document.body.classList.remove('modal-open');
                    }
                    window.location.reload(); 
                    return;
                }
            } catch (jsonErr) {
                if (typeof fermerModale === 'function') {
                    fermerModale();
                } else {
                    modal.close();
                    document.body.classList.remove('modal-open');
                }
                window.location.reload();
            }
        } else if (response.status === 422) {
            content.innerHTML = await response.text();
            // Attendre un peu avant de réinitialiser les boutons
            setTimeout(function() {
                initVoirPlusButtons();
            }, 100);
        }
    } catch (err) {
        console.error("Erreur lors de l'envoi du formulaire:", err);
    }
});
</script>
