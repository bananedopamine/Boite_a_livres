{# @author : Dufour Marc (marc.dufour@stjosup.com)
 # @version : 1
 # @dateCreate : 26/01/2026
 # @description : Logique JS et Structure de la modale pour les Mouvements (copié de Livre)
 #}

{# Structure de la Modale Mouvement #}
{# Cette dialog est masquée par défaut et sera pilotée par le JS ci-dessous #}
<dialog id="mouvement-modal" style="width: 50%; border-radius: 8px; border: 1px solid #ccc; padding: 20px;">
    {# Conteneur dynamique où le contenu (détails ou formulaire) sera injecté #}
    <div id="mouvement-modal-content"></div>
    <br>
    <button type="button" onclick="document.getElementById('mouvement-modal').close()">Fermer</button>
</dialog>

<script>
    /**
     * Fonction utilitaire pour charger du contenu dans la modale Mouvement
     */
    async function loadToMouvementModal(url) {
        const modal = document.getElementById('mouvement-modal');
        const content = document.getElementById('mouvement-modal-content');
        
        try {
            // Appel AJAX standard
            const response = await fetch(url, {
               headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            
            // Injection du HTML récupéré
            const html = await response.text();
            content.innerHTML = html;
            
            // Ouverture de la modale si elle n'est pas déjà ouverte
            if (modal && !modal.open) {
                modal.showModal();
            }
        } catch (err) {
            console.error('Erreur de chargement Mouvement :', err);
        }
    }

    // --- 1. OUVERTURE : Clic sur "Détails" ou "Modifier" (si classe .mouvement-modal-trigger) ---
    // Note : J'ai ajouté une classe spécifique 'mouvement-modal-trigger' pour ne pas entrer en conflit 
    // avec la modale des Livres si les deux sont sur la même page.
    document.addEventListener('click', (e) => {
        const trigger = e.target.closest('.mouvement-modal-trigger');
        if (trigger) {
            e.preventDefault();
            loadToMouvementModal(trigger.href);
        }
    });

    // --- 2. ENREGISTREMENT : Intercepter la soumission du formulaire DANS la modale ---
    document.addEventListener('submit', async (e) => {
        const content = document.getElementById('mouvement-modal-content');
        
        // Sécurité : On ne traite que les formulaires qui sont à l'intérieur de NOTRE modale
        if (!content || !content.contains(e.target)) return;

        const modal = document.getElementById('mouvement-modal');
        const form = e.target;
        
        e.preventDefault();
        
        const formData = new FormData(form);

        // [IMPORTANT] Ajout manuel du bouton submitter (comme vu dans _modal_livre_details)
        // Indispensable pour que Symfony détecte quel bouton a été cliqué (ex: Save vs Delete)
        if (e.submitter && e.submitter.name) {
            formData.append(e.submitter.name, e.submitter.value);
        }

        const actionUrl = form.getAttribute('action') || window.location.href;

        try {
            const response = await fetch(actionUrl, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            if (response.ok) {
                try {
                    const result = await response.json();
                    // Si le contrôleur renvoie du JSON {success: true}
                    if (result.success) {
                        modal.close();
                        window.location.reload(); 
                        return;
                    }
                } catch (jsonErr) {
                    // Fallback : Si le contrôleur renvoie du HTML ou une redirection sans JSON
                    modal.close();
                    window.location.reload();
                }
            } else if (response.status === 422) {
                // Erreur de validation (ex: champ vide) : On remplace le contenu par le formulaire avec erreurs
                content.innerHTML = await response.text();
            }
        } catch (err) {
            console.error("Erreur lors de l'envoi Mouvement :", err);
        }
    });
</script>